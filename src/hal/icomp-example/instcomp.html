<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Asciidoctor 0.1.3">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>instcomp HAL Component Generator</title>
<link rel="stylesheet" href="./asciidoctor.css">
</head>
<body class="article">
<div id="header">
<h1>instcomp HAL Component Generator</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a id="cha:instcomp-hal-component-generator"></a> </p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>instcomp is the Machinekit component compiler for instantiable components (.icomp)</p>
</div>
<div class="paragraph">
<p>This manual describes its operation in respect to how it differs from comp,
the default inherited Linuxcnc component compiler.</p>
</div>
<div class="paragraph">
<p>A familiarity with comp is therefore necessary and assumed.</p>
</div>
<div class="paragraph">
<p>The essential difference between normal realtime components and instantiable components
is&#8230;&#8230;KILLER EXPLANATION HERE&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;..</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_naming_conventions">Naming Conventions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All instantiable components are named to differentiate them from normal components</p>
</div>
<div class="paragraph">
<p>The component files have the extension <strong><em>.icomp</em></strong></p>
</div>
<div class="paragraph">
<p>The component is prefixed with <strong>i_</strong></p>
</div>
<div class="paragraph">
<p>eg</p>
</div>
<div class="paragraph">
<p><strong><em>i_ddt.icomp</em></strong>  is the component file</p>
</div>
<div class="paragraph">
<p>produces a component called</p>
</div>
<div class="paragraph">
<p><strong><em>i_ddt</em></strong></p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_definitions">Definitions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_component">component -</h3>
<div class="paragraph">
<p>A component is a single real-time base module, which is loaded with <em>halcmd loadrt</em>.</p>
</div>
<div class="paragraph">
<p>One <em>.icomp</em> file specifies one component.</p>
</div>

</div>
<div class="sect2">
<h3 id="_newinstance">newinstance -</h3>
<div class="paragraph">
<p>Each instance of a component created with a call to <strong><em>newinst</em></strong></p>
</div>
<div class="paragraph">
<p>It is created roughly equal (they all have the same functions, and data)</p>
</div>
<div class="paragraph">
<p>in basic configuration, but with greater or lesser numbers of pins or parameters, different names etc</p>
</div>
<div class="paragraph">
<p>New instances can be created ad hoc, one for the use at this time and another differing instance created at a later stage.</p>
</div>

</div>
<div class="sect2">
<h3 id="_function">function -</h3>
<div class="paragraph">
<p>The function is the part of the code that is attached to a thread and called at every thread period</p>
</div>
<div class="paragraph">
<p>You MUST declare at least one function in the declaration part of the icomp file above the <strong><em>;;</em></strong> delimiters</p>
</div>
<div class="paragraph">
<p>In this instcomp differs from comp</p>
</div>
<div class="paragraph">
<p>eg.</p>
</div>
<div class="paragraph">
<p><strong><em>function _;</em></strong></p>
</div>
<div class="paragraph">
<p><strong><em>;;</em></strong></p>
</div>
<div class="paragraph">
<p>This is perfectly sufficient where there is just one function</p>
</div>
<div class="paragraph">
<p>If there are more than one function, they must all be declared and uniquely named</p>
</div>
<div class="paragraph">
<p>eg.</p>
</div>
<div class="paragraph">
<p><strong><em>function read nofp;</em></strong></p>
</div>
<div class="paragraph">
<p><strong><em>function write;</em></strong></p>
</div>
<div class="paragraph">
<p><strong><em>;;</em></strong></p>
</div>
<div class="paragraph">
<p>The function is exported as a xthread function.</p>
</div>
<div class="paragraph">
<p>The following accessors are available within the function:</p>
</div>
<div class="literalblock">

<div class="content monospaced">
<pre>fa_period(fa) - formerly 'long period'"</pre>
</div>
</div>
<div class="literalblock">

<div class="content monospaced">
<pre>fa_thread_start_time(fa): _actual_ start time of thread invocation"</pre>
</div>
</div>
<div class="literalblock">

<div class="content monospaced">
<pre>fa_start_time(fa): _actual_ start time of function invocation"</pre>
</div>
</div>
<div class="literalblock">

<div class="content monospaced">
<pre>fa_thread_name(fa): name of the calling thread (char *)"</pre>
</div>
</div>
<div class="literalblock">

<div class="content monospaced">
<pre>fa_funct_name(fa): name of the this called function (char *)"</pre>
</div>
</div>
<div class="paragraph">
<p>The function will have the suffix <strong>xthread-funct</strong></p>
</div>
<div class="paragraph">
<p>eg</p>
</div>
<div class="paragraph">
<p><strong><em>i_ddt.xthread-funct</em></strong></p>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_instance_creation">Instance creation</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong><em>loadrt i_somecomponent</em></strong></p>
</div>
<div class="paragraph">
<p>Loads the component base making it ready for instantiation</p>
</div>
<div class="paragraph">
<p><strong><em>newinst i_somecomponent somecomp &lt;iprefix=""&gt; &lt;pincount=0&gt; &lt;other_instanceparam&#8658; extra_arg1 extra_arg2 &#8230;&#8230;</em></strong></p>
</div>
<div class="paragraph">
<p>Creates a new instance of i_somecomponent called somecomp</p>
</div>
<div class="paragraph">
<p>If iprefix is supplied, it overrules any iprefix set in the .comp file and is the prefix for all pin, param and thread names for that instance.</p>
</div>
<div class="paragraph">
<p>Thus a component i_xor_inst that returns the xor value of a value passed to its IN pins, in its OUT pins, could be instantiated
as i_xor2, i_xor4, i_xor6 etc by setting the iprefix to the name reflecting its use and setting pincount to the relevant number</p>
</div>
<div class="paragraph">
<p>Generally however it will be easier just to name the instance relevantly and leave the instanceparam iprefix empty in the .icomp file</p>
</div>
<div class="paragraph">
<p>eg</p>
</div>
<div class="paragraph">
<p><strong><em>newinst i_somecomponent somecomp8 pincount=8</em></strong></p>
</div>
<div class="paragraph">
<p>then</p>
</div>
<div class="paragraph">
<p><strong><em>addf somecomp8.xthread-funct servo-thread</em></strong></p>
</div>
<div class="paragraph">
<p>adds the function to a thread</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_reserved_declarations_etc">Reserved declarations etc.</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__em_pincount_em"><em>pincount</em></h3>
<div class="paragraph">
<p>is the reserved instance parameter name, which can be used as a numerator and index for arrays</p>
</div>
<div class="paragraph">
<p>Setting in the comp file:-</p>
</div>
<div class="paragraph">
<p><strong><em>instanceparam int pincount = 8;</em></strong></p>
</div>
<div class="paragraph">
<p>It can be used directly in the icomp file header as an array index size specifier</p>
</div>
<div class="paragraph">
<p>eg</p>
</div>
<div class="paragraph">
<p>pin in float in-##[pincount];</p>
</div>
<div class="paragraph">
<p>or in the function</p>
</div>
<div class="paragraph">
<p>for( x = 0; x &lt; pincount; x++)
    {
    // do stuff
    }</p>
</div>

</div>
<div class="sect2">
<h3 id="__em_maxpincount_em"><em>maxpincount</em></h3>
<div class="paragraph">
<p>is the reserved instance parameter name, which sets the maximum pins allowed to be created</p>
</div>
<div class="paragraph">
<p>It can only be set in the icomp header itself and cannot be altered</p>
</div>
<div class="paragraph">
<p>If it is not set in the icomp file, it will be computed based upon the highest array size specifier given
or pincount, whichever is greater</p>
</div>
<div class="paragraph">
<p>eg.</p>
</div>
<div class="paragraph">
<p><strong><em>instanceparam int maxpincount = 32;</em></strong></p>
</div>
<div class="paragraph">
<p><strong><em>instanceparam int pincount = 8;</em></strong></p>
</div>
<div class="paragraph">
<p>will create a default number of 8 in pins, up to a max of 32
If maxpincount is not set in the comp file, the maxpincount will be set to 8.</p>
</div>
<div class="paragraph">
<p>If pincount is supplied as an argument to the newinst call,</p>
</div>
<div class="paragraph">
<p>it overrules the preset number of pins in arrays using <em>pinprefix</em> as an index,</p>
</div>
<div class="paragraph">
<p>up to a maximum (maxpincount) which was set in the .comp file and fixed when the component base was compiled</p>
</div>

</div>
<div class="sect2">
<h3 id="__em_iprefix_em"><em>iprefix</em></h3>
<div class="paragraph">
<p>is the reserved instance parameter name, which sets the prefix to the new instance name</p>
</div>
<div class="paragraph">
<p>example as previous in Instance Creation</p>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_extra_args">Extra args</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Any additional args which do not match the RTAPI_IP_PARAM parameters expected, are passed through the argc / argv mechanism to the new component</p>
</div>
<div class="paragraph">
<p>Using in the comp file:-</p>
</div>
<div class="paragraph">
<p>'<strong>option extra_inst_setup; '</strong></p>
</div>
<div class="paragraph">
<p>allows you to create a function in your component, EXTRA_INST_SETUP(), which will receive the argc / argv data.
You can the parse and act upon extra arguments passed before the component is set <em>ready</em></p>
</div>
<div class="paragraph">
<p>A return value other than zero from this function will abort instance creation.</p>
</div>
<div class="paragraph">
<p>See the i_lutn example</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_syntax_and_options_differences">Syntax and Options differences</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some syntax and options are deprecated.</p>
</div>
<div class="ulist">

<ul>
<li>
<p><strong><em>personality</em></strong> has no meaning in these components, since instances are created singly and externally rather than within the component</p>
</li>
<li>
<p><strong><em>singleton</em></strong>  likewise not used, as all instances are single, but there can be multiple numbers of them</p>
<div class="literalblock">

<div class="content monospaced">
<pre>If your component must only have one instance in existence, use the comp compiler, there is no point in using instcomp.</pre>
</div>
</div>
<div class="literalblock">

<div class="content monospaced">
<pre>If you declare it you will get a warning but compilation will continue</pre>
</div>
</div>

</li>
<li>
<p><strong><em>count</em></strong>     Not used for the same reason as personality, only one instance is created at a time</p>
</li>
<li>
<p><strong><em>names</em></strong>     Just a synonym for count really, same comments apply</p>
</li>
<li>
<p><strong><em>userspace</em></strong>  No support for userspace at this time, use the comp / halcompile compiler</p>
</li>
</ul>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_options">Options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The differing options are:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><strong><em>option extra_inst_setup yes</em></strong> - (default: no)
If specified, call the function defined by <em>EXTRA_INST_SETUP</em> for each
instance.
argc and argv are passed to this function, so it is a good place to parse
additional arguments passed to the component in the newinst call</p>
</li>
<li>
<p><strong><em>option extra_cleanup yes</em></strong> - (default: no)
If specified, call the function defined by <em>EXTRA_INST_CLEANUP</em> from the
automatically defined <em>rtapi_app_exit</em>, or if an error is detected
in the automatically defined <em>rtapi_app_main</em>.</p>
</li>
<li>
<p><strong><em>instanceparam [int / string] param_name = &lt;value&gt;</em></strong>
Instanceparams that may be passed to the component at newinst
If value not set, will be set to 0 or "\0" respectively</p>
</li>
</ul>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_restrictions">Restrictions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Though HAL permits a pin, a parameter, and a function to have the same
name, instcomp does not.</p>
</div>
<div class="paragraph">
<p>Variable and function names that can not be used or are likely to cause
problems include:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Anything beginning with <em>inst</em></p>
</li>
<li>
<p><em>comp_id</em></p>
</li>
<li>
<p><em>fperiod</em></p>
</li>
<li>
<p><em>rtapi_app_main</em></p>
</li>
<li>
<p><em>rtapi_app_exit</em></p>
</li>
<li>
<p><em>extra_inst_setup</em></p>
</li>
<li>
<p><em>extra_inst_cleanup</em></p>
</li>
<li>
<p><em>function</em></p>
</li>
<li>
<p><em>iprefix</em></p>
</li>
<li>
<p><em>pincount</em></p>
</li>
<li>
<p><em>maxpincount</em></p>
</li>
</ul>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_compiling">Compiling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Same syntax and options as comp, just use instcomp instead.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_examples">Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Best form of explanation, below are 3 components demonstrating the
differing option usages etc.</p>
</div>
<div class="sect2">
<h3 id="_i_constant">i_constant</h3>
<div class="paragraph">
<p>Note this component is no different to the standard component.
The C code that is created is different and allows instantiation
but at comp file level, because arrays are not used and no need to
preset an iprefix for the default pin numbers, it all looks the same</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="highlight"><code class="c language-c">component i_constant_inst "Use a parameter to set the value of a pin";
pin out float out;
param rw float value;

function _;
license "GPL";
;;
FUNCTION(_) {
    out = value;
}</code></pre>
</div>
</div>

</div>
<div class="sect2">
<h3 id="_i_multiswitch">i_multiswitch</h3>
<div class="paragraph">
<p>This component uses an array of bit pins indexed with pincount
Maximum number of pins are 32 and the default is 6,
with a default iprefix which reflects this</p>
</div>
<div class="paragraph">
<p>extra_inst_setup is used, but just for initialisation of values
before entering the main loop</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="highlight"><code class="c language-c">component i_multiswitch_inst           """This component toggles between a specified number of output bits""";

pin in bit up = false           "Receives signal to toggle up";
pin in bit down = false         "Receives signal to toggle down";

param rw unsigned top-position  "Number of positions";
param rw signed position      "Current state (may be set in the HAL)";

pin out bit bit-##[pincount] = false       "Output bits";

instanceparam int maxpincount = 32;

instanceparam int pincount = 6;

instanceparam string iprefix = "mswitch6";

function _ ;
option extra_inst_setup yes;

variable int old_up = 0;
variable int old_down = 0;

author "ArcEye arceye@mgware.co.uk / Andy Pugh andy@bodgesoc.org";
license "GPL2";
;;


FUNCTION(_)
{
    int i;

    // debounce
    if (up &amp;&amp; !old_up) { position++; }
    if (down &amp;&amp; !old_down) { position--;}
    old_up = up;
    old_down = down;

    if (position &lt; 0) position = top_position;
    if (position &gt; top_position) position = 0;

    for (i = 0 ; i &lt; pincount; i++){
        bit(i) = (i == position);
    }

}

EXTRA_INST_SETUP(){
    top_position = pincount - 1;
    return 0;
}
</code></pre>
</div>
</div>

</div>
<div class="sect2">
<h3 id="_i_lutn">i_lutn</h3>
<div class="paragraph">
<p>This component has the same instanceparam features as before,
with an extra instanceparam defined - functn which takes a hex value</p>
</div>
<div class="paragraph">
<p>It can take further args not defined as instanceparams, which are passed
through the argc / argv mechanism and printed in extra_inst_setup()</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="highlight"><code class="c language-c">// instantiable lookup table component with configurable number of pins
// usage:
//
// halcmd newinst lutn and2 pincount=2 functn=0x8 arg1 arg2
// halcmd newinst lutn or2  pincount=2 functn=0xe arg1 arg2



component i_lutn "instantiable lookup table component with configurable number of pins";

    // Input Pins
pin in bit in-##[pincount];
pin out bit out;

instanceparam int maxpincount = 5;

instanceparam int pincount = 2;

instanceparam string iprefix = "lut2";

instanceparam int functn = 0;

option extra_inst_setup;

license "GPL";
author "Michael Haberler";

function _;
;;


FUNCTION(_)
{
int i;
int shift = 0;

    for (i = 0; i &lt; pincount; i++)
	if (in(i))
	    shift += (1 &lt;&lt; i);

    out = (functn &amp; (1 &lt;&lt; shift)) != 0;
}

// extra args not related to instanceparams can be parsed and dealt with here

EXTRA_INST_SETUP()
{
int x;

    for(x = 0; x &lt; argc; x++)
        hal_print_msg(RTAPI_MSG_ERR,"argv[%d] = %s", x, argv[x]);

    return 0;
}

</code></pre>
</div>
</div>

</div>

</div>
</div>

</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-04-03 17:05:12 BST
</div>
</div>
</body>
</html>